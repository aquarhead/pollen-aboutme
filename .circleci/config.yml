version: 2
jobs:
  pollen-publish:
    docker:
    - image: aquarhead/pollen:latest
    working_directory: ~/me
    steps:
    - checkout
    - run:
        name: "Pollen"
        command: |
          mkdir /publish
          raco pollen render -r
          raco pollen publish . /publish/aboutme
    - store_artifacts:
        path: /publish/aboutme
    - persist_to_workspace:
        root: /publish/aboutme
        paths:
        - "*"
  rsync-deploy:
    docker:
    - image: circleci/elixir:latest
    steps:
    - attach_workspace:
        at: ~/aboutme
    - add_ssh_keys
    - run:
        name: "Deploy via Rsync"
        command: |
          sudo apt-get update && sudo apt-get install rsync
          echo "[aqd.is]:8964 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC9zSpU2KLyc9F0oCDtvUtIMOPlN7rwOeOe4msmjyN+deb9TY6XkQTaiWXUHGufMgH/+iOvmAWOeFz2eoK7bzqYT65MzP3e73Tk6sELPMqVx0CybPCTE/6smlzl3ul69lDZt4+FAjdVPtpbFLnPAu45wVDOt6cpyAlGA/X22EMxf3npC6MfoTn9qXyGeyRCGorB5V3KOzhN0lhLQyDUll5bQ7fElQiW+5DJZ+6iv2fbb5QtSwic3X0PzFApQrPY0EomhLL/8GPmamOk7dbyfxyeTSfJRHXx2tFkY/1VNSuFFecO7uFhAWGH7lN6ZX6ExseKs41LP29+wqkMX3fdweGF" >> ~/.ssh/known_hosts
          chmod +x ~/aboutme
          rsync -va --delete -e "ssh -p 8964" ~/aboutme aquarhead@aqd.is:/home/aquarhead/deploy
workflows:
  version: 2
  publish-and-deploy:
    jobs:
    - pollen-publish
    - rsync-deploy:
        requires:
        - pollen-publish
        filters:
          branches:
            only: master
